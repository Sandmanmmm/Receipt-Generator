<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Memo #{{ invoice_number }}</title>
    <link rel="stylesheet" href="../css/credit_memo.css">
</head>
<body>
    <div class="invoice-page">
        <!-- Header -->
        {% if _is_first_page|default(true) %}
        <div class="header">
            <table class="header-table">
                <tr>
                    <td class="header-left">
                        {% if supplier_logo %}
                        <img src="{{ supplier_logo }}" alt="{{ supplier_name }}" class="supplier-logo" />
                        {% else %}
                        <div class="logo-placeholder">
                            <span class="logo-text">{{ supplier_name[:2]|upper }}</span>
                        </div>
                        {% endif %}
                        <div class="company-name">{{ supplier_name }}</div>
                    </td>
                    <td class="header-right">
                        <div class="doc-title">CREDIT MEMO</div>
                        <div class="doc-badge">REFUND DOCUMENT</div>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Reference Information Bar -->
        <div class="reference-bar">
            <table class="ref-table">
                <tr>
                    <td class="ref-item">
                        <div class="ref-label">Credit Memo #</div>
                        <div class="ref-value">{{ invoice_number }}</div>
                    </td>
                    <td class="ref-item">
                        <div class="ref-label">Issue Date</div>
                        <div class="ref-value">{{ invoice_date }}</div>
                    </td>
                    <td class="ref-item">
                        <div class="ref-label">Original Invoice #</div>
                        <div class="ref-value">{{ original_invoice_number|default('N/A') }}</div>
                    </td>
                    <td class="ref-item">
                        <div class="ref-label">Return Authorization</div>
                        <div class="ref-value">{{ rma_number|default('N/A') }}</div>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Address Section -->
        <div class="addresses">
            <table class="address-table">
                <tr>
                    <td class="address-col">
                        <div class="address-card card-from">
                            <div class="card-title">From (Seller)</div>
                            <div class="card-line"><strong>{{ supplier_name }}</strong></div>
                            {% if supplier_address %}
                            <div class="card-line">{{ supplier_address }}</div>
                            {% endif %}
                            {% if supplier_email %}
                            <div class="card-line">{{ supplier_email }}</div>
                            {% endif %}
                            {% if supplier_phone %}
                            <div class="card-line">{{ supplier_phone }}</div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="address-col">
                        <div class="address-card card-to">
                            <div class="card-title">Credit Issued To</div>
                            <div class="card-line"><strong>{{ buyer_name }}</strong></div>
                            {% if buyer_address %}
                            <div class="card-line">{{ buyer_address }}</div>
                            {% endif %}
                            {% if buyer_email %}
                            <div class="card-line">{{ buyer_email }}</div>
                            {% endif %}
                            {% if buyer_phone %}
                            <div class="card-line">{{ buyer_phone }}</div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Reason Section -->
        {% if credit_reason %}
        <div class="reason-section">
            <div class="reason-label">Reason for Credit:</div>
            <div class="reason-text">{{ credit_reason }}</div>
        </div>
        {% endif %}
        {% else %}
        <!-- Continuation Header -->
        <div class="continuation-header">
            <table class="cont-header-table">
                <tr>
                    <td class="cont-left">
                        {% if supplier_logo %}
                        <img src="{{ supplier_logo }}" alt="{{ supplier_name }}" class="logo-small" />
                        {% endif %}
                        <span class="cont-company">{{ supplier_name }}</span>
                    </td>
                    <td class="cont-center">
                        <span class="cont-title">CREDIT MEMO</span>
                    </td>
                    <td class="cont-right">
                        <span class="cont-info">Credit Memo #{{ invoice_number }}</span>
                        <span class="cont-page">Page {{ _current_page }} of {{ _total_pages }}</span>
                    </td>
                </tr>
            </table>
        </div>
        {% endif %}

        <!-- Items Table -->
        <table class="items-table">
            <thead>
                <tr>
                    <th class="col-line">#</th>
                    <th class="col-desc">Item Description</th>
                    <th class="col-sku">SKU</th>
                    <th class="col-qty">Qty</th>
                    <th class="col-price">Unit Price</th>
                    <th class="col-subtotal">Subtotal</th>
                    <th class="col-credit">Credit Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr class="item-row">
                    <td class="text-center">{{ loop.index }}</td>
                    <td>
                        <div class="item-name">{{ item.description }}</div>
                        {% if item.variant %}
                        <div class="item-variant">{{ item.variant }}</div>
                        {% endif %}
                    </td>
                    <td class="text-center">{{ item.sku|default('â€”') }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-right">{{ item.unit_price }}</td>
                    <td class="text-right">{{ item.total }}</td>
                    <td class="text-right credit-amount">{{ item.total }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Totals Section (Last Page Only) -->
        {% if _is_last_page|default(true) %}
        <div class="totals-section">
            <table class="totals-table">
                <tr>
                    <td class="totals-spacer"></td>
                    <td class="totals-content">
                        <table class="totals-breakdown">
                            <tr>
                                <td class="total-label">Subtotal:</td>
                                <td class="total-value">{{ subtotal }}</td>
                            </tr>
                            {% if discount %}
                            <tr>
                                <td class="total-label">Discount:</td>
                                <td class="total-value discount-value">-{{ discount }}</td>
                            </tr>
                            {% endif %}
                            {% if shipping_cost %}
                            <tr>
                                <td class="total-label">Shipping Credit:</td>
                                <td class="total-value">-{{ shipping_cost }}</td>
                            </tr>
                            {% endif %}
                            {% if tax_amount %}
                            <tr>
                                <td class="total-label">Tax Credit:</td>
                                <td class="total-value">-{{ tax_amount }}</td>
                            </tr>
                            {% endif %}
                            <tr class="total-final">
                                <td class="total-label-main">Total Credit Amount:</td>
                                <td class="total-value-main">{{ total_amount }}</td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Credit Application Method -->
        <div class="payment-section">
            <div class="payment-card">
                <div class="payment-title">Credit Application</div>
                <div class="payment-row">
                    <span class="payment-label">Method:</span>
                    <span class="payment-value">{{ payment_method|default('Original Payment Method') }}</span>
                </div>
                {% if payment_details %}
                <div class="payment-row">
                    <span class="payment-label">Details:</span>
                    <span class="payment-value">{{ payment_details }}</span>
                </div>
                {% endif %}
                <div class="payment-row">
                    <span class="payment-label">Processing Time:</span>
                    <span class="payment-value">3-5 business days</span>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        {% if notes %}
        <div class="notes-section">
            <div class="notes-title">Notes</div>
            <div class="notes-text">{{ notes }}</div>
        </div>
        {% endif %}

        <!-- Footer -->
        <div class="footer">
            <div class="footer-section">
                <div class="footer-title">Important Information</div>
                <div class="footer-text">
                    This credit memo reduces the amount owed to {{ supplier_name }}. 
                    The credit will be applied according to the method specified above. 
                    Please retain this document for your records.
                </div>
            </div>
            {% if terms %}
            <div class="footer-section">
                <div class="footer-title">Terms & Conditions</div>
                <div class="footer-text">{{ terms }}</div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Continuation Footer -->
        <div class="continuation-footer">
            <span class="cont-footer-text">Continued on next page...</span>
            <span class="cont-footer-page">Page {{ _current_page }} of {{ _total_pages }}</span>
        </div>
        {% endif %}

        <!-- Page Number (All Pages) -->
        <div class="page-number">
            Page {{ _current_page|default(1) }} of {{ _total_pages|default(1) }}
        </div>
    </div>
</body>
</html>
