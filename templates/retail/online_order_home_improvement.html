<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Improvement Order{% if _page_number|default(none) %} - Page {{ _page_number }} of {{ _total_pages }}{% endif %}</title>
    <link rel="stylesheet" href="../css/online_order_home_improvement.css">
</head>
<body>
    <div class="home-improvement-invoice">
        {% if _is_first_page|default(true) %}
        <!-- Header -->
        <div class="invoice-header">
            <div class="company-section">
                <div class="company-logo">
                    <span class="logo-icon">üèóÔ∏è</span>
                </div>
                <div class="company-info">
                    <h1 class="company-name">{{ supplier_name }}</h1>
                    <p class="company-tagline">{{ tagline }}</p>
                    <p class="company-phone">{{ supplier_phone }}</p>
                </div>
            </div>
            <div class="order-header">
                <div class="order-type-badge">HOME IMPROVEMENT ORDER</div>
                <div class="order-number">Order #{{ order_number }}</div>
                <div class="order-date">Ordered: {{ order_date }}</div>
            </div>
        </div>

        <!-- Project Information -->
        {% if project_name %}
        <div class="project-banner">
            <div class="project-icon"></div>
            <div class="project-details">
                <div class="project-name">{{ project_name }}</div>
                <div class="project-description">{{ project_description }}</div>
            </div>
        </div>
        {% endif %}

        <!-- Delivery & Installation Info -->
        <div class="info-grid">
            <div class="info-panel customer-panel">
                <h3 class="panel-title">
                    <span class="panel-icon">üë§</span>
                    Customer Information
                </h3>
                <p class="customer-name">{{ buyer_name }}</p>
                <p class="customer-phone">{{ buyer_phone }}</p>
                <p class="customer-email">{{ buyer_email }}</p>
                {% if pro_member %}
                <div class="pro-badge">
                    <span class="pro-icon"></span>
                    <span class="pro-text">PRO Member</span>
                </div>
                {% endif %}
            </div>

            <div class="info-panel delivery-panel">
                <h3 class="panel-title">
                    <span class="panel-icon"></span>
                    Delivery Details
                </h3>
                <p class="delivery-address">{{ delivery_address }}</p>
                <p class="delivery-city">{{ delivery_city }}, {{ delivery_state }} {{ delivery_zip }}</p>
                <div class="delivery-method-box">
                    <span class="method-icon"></span>
                    <span class="method-text">{{ delivery_method }}</span>
                </div>
                {% if estimated_delivery %}
                <div class="delivery-date">
                    <strong>Est. Delivery:</strong> {{ estimated_delivery }}
                </div>
                {% endif %}
            </div>

            {% if installation_scheduled %}
            <div class="info-panel installation-panel">
                <h3 class="panel-title">
                    <span class="panel-icon"></span>
                    Installation Service
                </h3>
                <p class="installation-date">
                    <strong>Scheduled:</strong> {{ installation_date }}
                </p>
                <p class="installation-window">{{ installation_time_window }}</p>
                {% if technician_name %}
                <p class="technician">Technician: {{ technician_name }}</p>
                {% endif %}
                <p class="installation-note">We'll call 30 minutes before arrival</p>
            </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Continuation Header -->
        <div class="continuation-header" style="padding: 20px; background: #fff3e0; border-bottom: 3px solid #ff9800; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #e65100;">{{ supplier_name }}</div>
                    <div style="color: #666; margin-top: 5px;">Order {{ order_number }} (Continued)</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 16px; color: #666;">Page {{ _page_number }} of {{ _total_pages }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Materials & Products -->
        <div class="items-section">
            <h2 class="section-heading">
                <span class="heading-icon"></span>
                Order Items
            </h2>

            {# Support both categorized and flat item lists #}
            {% if item_categories %}
            {# Pagination handled by template config - iterate over full list #}
            {% for category in item_categories %}
            <!-- Category Group -->
            <div class="category-group">
                <div class="category-header">
                    <span class="category-icon">{{ category.icon }}</span>
                    <span class="category-name">{{ category.name }}</span>
                    <span class="category-count">({{ category.items|length }} items)</span>
                </div>

                {% for item in category.items %}
                <div class="item-card">
                    <div class="item-image-box">
                        <div class="item-image-placeholder">
                            <span class="image-icon">üì∑</span>
                        </div>
                    </div>

                    <div class="item-details">
                        <h4 class="item-name">{{ item.description }}</h4>
                        
                        {% if item.brand %}
                        <div class="item-brand">Brand: <strong>{{ item.brand }}</strong></div>
                        {% endif %}

                        {% if item.model_number %}
                        <div class="item-model">
                            <span class="model-label">Model:</span>
                            <span class="model-value">{{ item.model_number }}</span>
                        </div>
                        {% endif %}

                        {% if item.sku %}
                        <div class="item-sku">SKU: {{ item.sku }}</div>
                        {% endif %}

                        <!-- Measurements & Specifications -->
                        {% if item.dimensions %}
                        <div class="item-dimensions">
                            <span class="dim-icon"></span>
                            <span class="dim-text">{{ item.dimensions }}</span>
                        </div>
                        {% endif %}

                        {% if item.color %}
                        <div class="item-color">
                            <span class="color-label">Color:</span>
                            <span class="color-swatch" style="background-color: {{ item.color_hex }};"></span>
                            <span class="color-name">{{ item.color }}</span>
                        </div>
                        {% endif %}

                        {% if item.finish %}
                        <div class="item-finish">
                            <span class="finish-label">Finish:</span>
                            <span class="finish-value">{{ item.finish }}</span>
                        </div>
                        {% endif %}

                        {% if item.material %}
                        <div class="item-material">
                            <span class="material-label">Material:</span>
                            <span class="material-value">{{ item.material }}</span>
                        </div>
                        {% endif %}

                        <!-- Coverage/Capacity -->
                        {% if item.coverage %}
                        <div class="item-coverage">
                            <span class="coverage-icon"></span>
                            <span class="coverage-text">Coverage: {{ item.coverage }}</span>
                        </div>
                        {% endif %}

                        {% if item.capacity %}
                        <div class="item-capacity">
                            <span class="capacity-text">Capacity: {{ item.capacity }}</span>
                        </div>
                        {% endif %}

                        <!-- Bulk Quantity Indicator -->
                        {% if item.quantity > 10 %}
                        <div class="bulk-indicator">
                            <span class="bulk-icon"></span>
                            <span class="bulk-text">Bulk Purchase</span>
                        </div>
                        {% endif %}

                        <!-- Installation Required -->
                        {% if item.installation_required %}
                        <div class="installation-badge">
                            <span class="install-icon"></span>
                            <span class="install-text">Professional Installation Required</span>
                        </div>
                        {% endif %}

                        <!-- Warranty Info -->
                        {% if item.warranty %}
                        <div class="warranty-info">
                            <span class="warranty-icon"></span>
                            <span class="warranty-text">{{ item.warranty }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="item-pricing">
                        <div class="quantity-section">
                            <span class="qty-label">Qty:</span>
                            <span class="qty-value">{{ item.quantity }}</span>
                            {% if item.unit_measure %}
                            <span class="qty-unit">{{ item.unit_measure }}</span>
                            {% endif %}
                        </div>
                        <div class="price-section">
                            <div class="unit-price">{{ item.unit_price }} each</div>
                            {% if item.price_per_measure %}
                            <div class="price-per-measure">({{ item.price_per_measure }}/{{ item.measure_unit }})</div>
                            {% endif %}
                            {% if item.discount|to_float > 0 %}
                            <div class="item-discount">
                                <span class="discount-badge">SAVE</span>
                                <span class="discount-amount">{{ item.discount }}</span>
                            </div>
                            {% endif %}
                            <div class="item-total">{{ item.total }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
            {% else %}
            {# Fallback for flat line_items list - pagination handled by template config #}
            <div class="category-group">
                <div class="category-header">
                    <span class="category-icon">üõ†Ô∏è</span>
                    <span class="category-name">Products</span>
                    <span class="category-count">({{ line_items|length }} items)</span>
                </div>

                {% for item in items|default(line_items, true) %}
                <div class="item-card">
                    <div class="item-image-box">
                        <div class="item-image-placeholder">
                            <span class="image-icon">üì∑</span>
                        </div>
                    </div>

                    <div class="item-details">
                        <h4 class="item-name">{{ item.description }}</h4>
                        
                        {% if item.sku %}
                        <div class="item-sku">SKU: {{ item.sku }}</div>
                        {% endif %}
                    </div>

                    <div class="item-pricing">
                        <div class="price-row">
                            <span class="price-label">Qty:</span>
                            <span class="price-value">{{ item.quantity }}</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">Unit Price:</span>
                            <span class="price-value">{{ item.unit_price }}</span>
                        </div>
                        <div class="price-row total">
                            <span class="price-label">Total:</span>
                            <span class="price-value">{{ item.total }}</span>
                        </div>
                        <div class="item-actions">
                            <div class="item-total">{{ item.total }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Installation Services -->
        {% if installation_services %}
        <div class="services-section">
            <h3 class="services-title">
                <span class="services-icon"></span>
                Installation & Services
            </h3>
            {% for service in installation_services %}
            <div class="service-item">
                <div class="service-details">
                    <div class="service-name">{{ service.name }}</div>
                    <div class="service-description">{{ service.description }}</div>
                    {% if service.estimated_hours %}
                    <div class="service-duration">
                        <span class="duration-icon">‚è±Ô∏è</span>
                        <span class="duration-text">Est. {{ service.estimated_hours }} hours</span>
                    </div>
                    {% endif %}
                </div>
                <div class="service-price">{{ service.price }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Project Supplies/Tools -->
        {% if rental_equipment %}
        <div class="rental-section">
            <h3 class="rental-title">
                <span class="rental-icon">üõ†Ô∏è</span>
                Tool Rentals
            </h3>
            {% for rental in rental_equipment %}
            <div class="rental-item">
                <div class="rental-details">
                    <div class="rental-name">{{ rental.name }}</div>
                    <div class="rental-period">{{ rental.rental_period }}</div>
                </div>
                <div class="rental-price">{{ rental.price }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if _is_last_page|default(true) %}
        <!-- Order Summary -->
        <div class="totals-section">
            <div class="totals-container">
                <h3 class="totals-title">Order Summary</h3>
                <div class="totals-table">
                    <div class="total-row">
                        <span class="total-label">Materials Subtotal ({{ total_items }} items):</span>
                        <span class="total-value">{{ materials_subtotal }}</span>
                    </div>
                    {% if item_discounts and item_discounts|float > 0 %}
                    <div class="total-row discount-row">
                        <span class="total-label"> Item Discounts:</span>
                        <span class="total-value discount-value">-${{ "%.2f"|format(item_discounts) }}</span>
                    </div>
                    {% endif %}
                    {% if installation_total and installation_total|float > 0 %}
                    <div class="total-row">
                        <span class="total-label">Installation Services:</span>
                        <span class="total-value">{{ installation_total }}</span>
                    </div>
                    {% endif %}
                    {% if rental_total and rental_total|float > 0 %}
                    <div class="total-row">
                        <span class="total-label">Tool Rentals:</span>
                        <span class="total-value">{{ rental_total }}</span>
                    </div>
                    {% endif %}
                    <div class="total-row">
                        <span class="total-label">Delivery ({{ delivery_method }}):</span>
                        <span class="total-value">{{ delivery_charge }}</span>
                    </div>
                    {% if haul_away_fee and haul_away_fee|float > 0 %}
                    <div class="total-row">
                        <span class="total-label">Old Appliance Haul-Away:</span>
                        <span class="total-value">{{ haul_away_fee }}</span>
                    </div>
                    {% endif %}
                    <div class="total-row">
                        <span class="total-label">Tax:</span>
                        <span class="total-value">{{ tax_amount }}</span>
                    </div>
                    <div class="total-row grand-total">
                        <span class="total-label">Order Total:</span>
                        <span class="total-value">{{ total_amount }}</span>
                    </div>
                    {% if total_savings and total_savings|float > 0 %}
                    <div class="savings-highlight">
                        <span class="savings-icon"></span>
                        <span class="savings-text">Total Savings: {{ total_savings }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Payment Information -->
        <div class="payment-section">
            <h3 class="section-heading">
                <span class="heading-icon"></span>
                Payment Details
            </h3>
            <div class="payment-card">
                <div class="payment-method">
                    <span class="payment-icon"></span>
                    <span class="payment-type">{{ payment_method }}</span>
                    <span class="card-details">{{ card_type }} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ card_last_four }}</span>
                </div>
                <div class="payment-status">
                    <span class="status-badge paid">PAID</span>
                </div>
            </div>
            {% if transaction_id %}
            <div class="transaction-ref">
                <span class="ref-label">Transaction ID:</span>
                <span class="ref-value">{{ transaction_id }}</span>
            </div>
            {% endif %}
        </div>

        <!-- Pro Rewards -->
        {% if pro_member and rewards_earned %}
        <div class="rewards-section">
            <div class="rewards-banner">
                <h3 class="rewards-title"> PRO Rewards Update</h3>
                <div class="rewards-grid">
                    <div class="reward-stat">
                        <div class="stat-value">{{ rewards_earned }}</div>
                        <div class="stat-label">Points Earned</div>
                    </div>
                    <div class="reward-stat">
                        <div class="stat-value">{{ rewards_balance }}</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                    <div class="reward-stat">
                        <div class="stat-value">{{ cash_back_earned }}</div>
                        <div class="stat-label">Cash Back</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Return Policy -->
        <div class="policy-section">
            <h3 class="policy-title">Return & Exchange Policy</h3>
            <div class="policy-content">
                <div class="policy-item">
                    <span class="policy-icon">‚úì</span>
                    <span class="policy-text">{{ return_window }} day return policy on most items</span>
                </div>
                <div class="policy-item">
                    <span class="policy-icon">‚úì</span>
                    <span class="policy-text">Original receipt and packaging required</span>
                </div>
                {% if return_deadline %}
                <div class="policy-deadline">
                    <strong>Return by:</strong> {{ return_deadline }}
                </div>
                {% endif %}
                <div class="policy-note">
                    Some items may have different return policies. Opened electrical items may be subject to a 15% restocking fee.
                </div>
            </div>
        </div>

        <!-- DIY Resources -->
        <div class="resources-section">
            <h3 class="resources-title">üìö DIY Resources</h3>
            <div class="resources-content">
                <p>Need help with your project? Visit our website for:</p>
                <ul class="resources-list">
                    <li>Step-by-step installation guides</li>
                    <li>Video tutorials and how-to's</li>
                    <li>Tool rental information</li>
                    <li>Project calculators</li>
                </ul>
            </div>
        </div>

        <!-- Footer -->
        <div class="invoice-footer">
            <div class="footer-grid">
                <div class="footer-column">
                    <h4>Customer Service</h4>
                    <p>Phone: {{ support_phone }}</p>
                    <p>Email: {{ support_email }}</p>
                    <p>Store Hours: {{ store_hours }}</p>
                </div>
                <div class="footer-column">
                    <h4>Store Location</h4>
                    <p>{{ store_address }}</p>
                    <p>{{ store_city }}, {{ store_state }} {{ store_zip }}</p>
                    <p>Store #{{ store_number }}</p>
                </div>
                <div class="footer-column">
                    <h4>PRO Services</h4>
                    <p>Join PRO for exclusive benefits</p>
                    <p>Volume discounts available</p>
                    <p>Dedicated PRO desk</p>
                </div>
            </div>
            <div class="footer-legal">
                <p>Thank you for choosing {{ supplier_name }} for your home improvement project!</p>
                <p>Questions about your order? Call {{ support_phone }} and reference Order #{{ order_number }}</p>
            </div>
        </div>
        {% else %}
        <!-- Continuation Footer -->
        <div class="continuation-footer" style="margin-top: 30px; padding: 20px; background: #fff3e0; border-top: 2px solid #ddd; text-align: center;">
            <div style="color: #666; font-size: 14px;">Continued on page {{ (_page_number|default(1)) + 1 }}...</div>
        </div>
        {% endif %}
    </div>
</body>
</html>
