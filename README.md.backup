# InvoiceGen - Synthetic Invoice Generator with LayoutLMv3 Training

A complete end-to-end pipeline for generating synthetic invoices and training custom LayoutLMv3 models for document understanding.

## ğŸ¯ Project Overview

This project provides a standalone system to:
1. **Generate** realistic synthetic invoices with randomized data
2. **Render** invoices to PDF and PNG formats
3. **Auto-annotate** documents using OCR with entity labeling
4. **Augment** images with realistic distortions
5. **Convert** annotations to LayoutLMv3 training format
6. **Train** custom LayoutLMv3 models
7. **Evaluate** and iterate on model performance
8. **Deploy** models to production

## ğŸ“‹ High-Level Roadmap

1. âœ… Build invoice layout templates (HTML/CSS + Jinja2)
2. âœ… Build synthetic data generator (randomize fields, layouts, fonts, colors, distortions)
3. âœ… Render PDFs & PNGs (wkhtmltopdf or Puppeteer)
4. âœ… Auto-annotate everything (extract DOM bounding boxes â†’ generate JSON)
5. âœ… Apply augmentation (noise, blur, deskew, compression, stains)
6. âœ… Convert to LayoutLMv3 training format (PaddleOCR + tokenizer)
7. âœ… **Production-ready labels**: 73 BIO labels for complete invoice/PO extraction
8. âœ… **Multi-task model**: LayoutLMv3 with NER + Table Detection + CRF
9. âœ… **Validation tools**: Schema validation and visualization utilities
10. â¬œ Upload to vast.ai (run generator at scale)
11. â¬œ Train on large-scale dataset
12. â¬œ Evaluate, iterate, refine templates
13. â¬œ Deploy the best checkpoint to production

## ğŸ—ï¸ Project Structure

```
InvoiceGen/
â”œâ”€â”€ templates/              # Invoice templates
â”‚   â”œâ”€â”€ html/              # Jinja2 HTML templates
â”‚   â”‚   â”œâ”€â”€ modern_invoice.html
â”‚   â”‚   â””â”€â”€ classic_invoice.html
â”‚   â””â”€â”€ css/               # Stylesheets
â”‚       â”œâ”€â”€ modern_invoice.css
â”‚       â””â”€â”€ classic_invoice.css
â”œâ”€â”€ generators/            # Synthetic data generation
â”‚   â”œâ”€â”€ synthetic_data.py  # Random invoice data generator
â”‚   â””â”€â”€ renderer.py        # HTML to PDF/PNG rendering
â”œâ”€â”€ annotation/            # Auto-annotation system
â”‚   â””â”€â”€ annotator.py       # OCR-based bbox extraction
â”œâ”€â”€ augmentation/          # Image augmentation
â”‚   â””â”€â”€ augmenter.py       # Realistic distortions
â”œâ”€â”€ training/              # LayoutLMv3 training
â”‚   â”œâ”€â”€ layoutlmv3_multihead.py  # Multi-task model architecture
â”‚   â”œâ”€â”€ data_converter.py  # Convert to training format
â”‚   â””â”€â”€ train.py           # Training script
â”œâ”€â”€ evaluation/            # Model evaluation tools
â”‚   â””â”€â”€ evaluate.py        # Metrics and analysis
â”œâ”€â”€ deployment/            # Production deployment
â”‚   â””â”€â”€ api.py             # FastAPI server
â”œâ”€â”€ config/                # Configuration files
â”‚   â”œâ”€â”€ config.yaml        # Pipeline configuration
â”‚   â”œâ”€â”€ labels.yaml        # 73 BIO labels
â”‚   â””â”€â”€ training_config.yaml  # Training hyperparameters
â”œâ”€â”€ docs/                  # Documentation
â”‚   â”œâ”€â”€ ANNOTATION_SCHEMA.md  # Annotation format spec
â”‚   â””â”€â”€ TRAINING_SETUP.md     # Training guide
â”œâ”€â”€ scripts/               # Utility scripts
â”‚   â”œâ”€â”€ pipeline.py        # End-to-end pipeline
â”‚   â”œâ”€â”€ validate_annotations.py  # Schema validator
â”‚   â””â”€â”€ visualize_annotations.py # Annotation viewer
â”œâ”€â”€ data/                  # Data directory
â”‚   â”œâ”€â”€ raw/              # Generated invoices
â”‚   â”œâ”€â”€ processed/        # Augmented images
â”‚   â”œâ”€â”€ annotations/      # JSON annotations
â”‚   â””â”€â”€ layoutlmv3/       # Training data
â”œâ”€â”€ models/               # Trained models
â”œâ”€â”€ tests/                # Unit tests
â”œâ”€â”€ requirements.txt      # Python dependencies
â””â”€â”€ README.md            # This file
```

## ğŸš€ Quick Start

### Prerequisites

- Python 3.9+
- CUDA-capable GPU (recommended for training)
- wkhtmltopdf or WeasyPrint for PDF rendering
- Poppler for PDF to image conversion

### Installation

1. **Clone the repository:**
```bash
git clone <repository-url>
cd InvoiceGen
```

2. **Create virtual environment:**
```bash
python -m venv venv
# Windows
.\venv\Scripts\activate
# Linux/Mac
source venv/bin/activate
```

3. **Install dependencies:**
```bash
pip install -r requirements.txt
```

4. **Install system dependencies:**

**Windows:**
- Download wkhtmltopdf: https://wkhtmltopdf.org/downloads.html
- Download Poppler: https://github.com/oschwartz10612/poppler-windows/releases/
- Add both to PATH

**Linux:**
```bash
sudo apt-get update
sudo apt-get install wkhtmltopdf poppler-utils
```

**Mac:**
```bash
brew install wkhtmltopdf poppler
```

### Usage

#### Run Complete Pipeline

Generate 100 invoices and train a model:
```bash
python scripts/pipeline.py pipeline --num-samples 100
```

#### Run Individual Steps

**1. Generate Invoices:**
```bash
python scripts/pipeline.py generate --num-samples 100
```

**2. Auto-Annotate:**
```bash
python scripts/pipeline.py annotate
```

**3. Augment Images:**
```bash
python scripts/pipeline.py augment
```

**4. Convert to LayoutLMv3 Format:**
```bash
python scripts/pipeline.py convert
```

**5. Train Model:**
```bash
python scripts/pipeline.py train
```

## ğŸ“ Configuration

Edit `config/config.yaml` to customize:

- **Generation settings**: Number of items, locales, templates
- **Augmentation**: Noise, blur, rotation, perspective, etc.
- **OCR engine**: PaddleOCR, Tesseract, or EasyOCR
- **Training hyperparameters**: Learning rate, batch size, epochs
- **Entity labels**: Custom entity types for your use case

## ğŸ¨ Templates

### Available Templates

1. **modern_invoice.html** - Clean, professional design
2. **classic_invoice.html** - Traditional invoice layout

### Creating Custom Templates

1. Create HTML template in `templates/html/`
2. Create corresponding CSS in `templates/css/`
3. Use Jinja2 syntax for dynamic content:
```html
<h1>{{ company_name }}</h1>
<p>Invoice #{{ invoice_number }}</p>
```

4. Add template to `config/config.yaml`:
```yaml
generation:
  templates:
    - "modern_invoice.html"
    - "your_custom_template.html"
```

## ğŸ”§ Advanced Usage

### Custom Entity Labels

Edit `config/config.yaml` to define custom entities:
```yaml
entity_labels:
  - "O"
  - "B-CUSTOM_FIELD"
  - "I-CUSTOM_FIELD"
  - "B-ANOTHER_FIELD"
  - "I-ANOTHER_FIELD"
```

### Augmentation Tuning

Adjust augmentation probabilities and intensities:
```yaml
augmentation:
  noise:
    enabled: true
    probability: 0.7  # 70% chance
    intensity_range: [0.01, 0.05]
```

### Multi-GPU Training

Edit training config for distributed training:
```python
# In training/train.py
config = TrainingConfig(
    per_device_train_batch_size=8,
    gradient_accumulation_steps=2,
    # ... other settings
)
```

## ğŸ“Š Evaluation

Evaluate trained model:
```python
from training.train import InvoiceTrainer, TrainingConfig

config = TrainingConfig(
    data_dir="data/layoutlmv3",
    output_dir="models/layoutlmv3-invoice"
)

trainer = InvoiceTrainer(config)
metrics = trainer.evaluate()
```

## ğŸš¢ Deployment

### API Server

Create FastAPI endpoint:
```python
from fastapi import FastAPI, UploadFile
from transformers import LayoutLMv3ForTokenClassification

app = FastAPI()
model = LayoutLMv3ForTokenClassification.from_pretrained("models/layoutlmv3-invoice")

@app.post("/predict")
async def predict(file: UploadFile):
    # Process image and return predictions
    pass
```

Run server:
```bash
uvicorn deployment.api:app --host 0.0.0.0 --port 8000
```

## â˜ï¸ Vast.ai Integration

For large-scale generation:

1. **Create vast.ai instance:**
```bash
vastai create instance <instance-id> --image pytorch/pytorch:2.0.0-cuda11.7-cudnn8-runtime
```

2. **Upload code:**
```bash
rsync -avz InvoiceGen/ root@<instance-ip>:/workspace/
```

3. **Run generation at scale:**
```bash
python scripts/pipeline.py generate --num-samples 10000
```

## ğŸ§ª Testing

Run unit tests:
```bash
pytest tests/
```

Run with coverage:
```bash
pytest --cov=. tests/
```

## ğŸ“š Documentation

### Key Classes

- **`SyntheticDataGenerator`**: Generate random invoice data
- **`InvoiceRenderer`**: Render templates to PDF/PNG
- **`OCRAnnotator`**: Extract text and bounding boxes
- **`EntityLabeler`**: Label bounding boxes with entity types
- **`ImageAugmenter`**: Apply realistic distortions
- **`LayoutLMv3Converter`**: Convert to training format
- **`InvoiceTrainer`**: Train LayoutLMv3 models

### Example: Generate Single Invoice

```python
from generators.synthetic_data import SyntheticDataGenerator
from generators.renderer import InvoiceRenderer

# Generate data
generator = SyntheticDataGenerator(locale='en_US')
invoice = generator.generate_invoice()
invoice_dict = generator.invoice_to_dict(invoice)

# Render
renderer = InvoiceRenderer(templates_dir='templates/html')
results = renderer.render_invoice(
    template_name='modern_invoice.html',
    data=invoice_dict,
    invoice_id=invoice.invoice_number,
    formats=['pdf', 'png']
)
```

## ğŸ› Troubleshooting

**Issue**: wkhtmltopdf not found
- **Solution**: Install wkhtmltopdf and add to PATH, or use WeasyPrint backend

**Issue**: CUDA out of memory
- **Solution**: Reduce batch size in `config/config.yaml`

**Issue**: OCR not detecting text
- **Solution**: Try different OCR engine (PaddleOCR, Tesseract, EasyOCR)

**Issue**: Poor model performance
- **Solution**: Generate more training data, tune augmentation, adjust learning rate

## ğŸ¤ Contributing

Contributions welcome! Areas for improvement:

- Additional invoice templates
- Support for more languages/locales
- Advanced augmentation techniques
- Model optimization for inference
- API deployment examples

## ğŸ“„ License

MIT License - see LICENSE file for details

## ğŸ™ Acknowledgments

- [LayoutLMv3](https://github.com/microsoft/unilm/tree/master/layoutlmv3) by Microsoft
- [PaddleOCR](https://github.com/PaddlePaddle/PaddleOCR) by PaddlePaddle
- [Faker](https://github.com/joke2k/faker) for synthetic data generation

## ğŸ“§ Contact

For questions or issues, please open an issue on GitHub.

---

**Happy Training! ğŸš€**
